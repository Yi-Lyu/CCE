# CCE 客户端测试指南

## 快速验证步骤

### 1. 验证端口显示修复 ✅

**问题**：之前显示 `127.0.0.1:槢` （乱码）
**预期**：应显示 `127.0.0.1:27015`

**测试步骤**：
```bash
cd /Users/ethan/code/Claude-Code-Exchange/cce-client
open CCE.app
```

1. 应用启动后，点击菜单栏图标
2. 选择「显示主窗口」
3. 确认「服务控制」标签页
4. 检查「服务信息」卡片中的「代理端口」显示

**✅ 成功标志**：显示 `代理端口: 127.0.0.1:27015`

---

### 2. 验证服务添加功能 ✅

**测试步骤**：
1. 切换到「配置编辑」标签
2. 确认在「服务管理」子标签
3. 点击「添加服务」按钮

**表单测试**：
- 输入服务 ID：`test-api`
- 输入服务名称：`测试 API`
- 输入 API URL：`https://api.example.com/v1/messages`
- 输入 API Key：`sk-test-1234567890`
- 选择角色：`executor`
- 勾选「支持 Thinking」
- 点击「保存」

**✅ 成功标志**：
- 弹出提示「服务已保存（请记得点击保存配置按钮）」
- 服务列表中出现新服务 `test-api (测试 API)`

---

### 3. 验证服务编辑功能 ✅

**测试步骤**：
1. 在服务列表中点击选中 `test-api`
2. 点击「编辑服务」按钮
3. 修改服务名称为：`测试 API（已编辑）`
4. 点击「保存」

**✅ 成功标志**：
- 服务名称在列表中更新
- 服务 ID 字段为灰色（不可编辑）

---

### 4. 验证服务删除功能 ✅

**测试步骤**：
1. 在服务列表中选中 `test-api`
2. 点击「删除服务」按钮
3. 在确认对话框中点击「是」

**✅ 成功标志**：
- 服务从列表中消失
- 弹出提示「服务已删除（请记得点击保存配置按钮）」

---

### 5. 验证日志级别过滤 ✅

**前提**：代理服务已运行并产生日志

**测试步骤**：
1. 切换到「日志查看」标签
2. 默认选择「全部」级别，应显示所有日志
3. 选择「debug」级别

**✅ 成功标志**：
- 只显示包含 debug 级别的日志行
- 日志内容应包含 `"level":"debug"` 或 `[debug]`

**测试其他级别**：
- 选择「info」→ 只显示 info 级别日志
- 选择「warn」→ 只显示 warn 级别日志
- 选择「error」→ 只显示 error 级别日志

---

### 6. 验证配置保存和重启 ✅

**测试步骤**：
1. 在「配置编辑」中做任何修改（如修改功能开关）
2. 点击底部「保存配置并重启服务」按钮
3. 观察提示信息

**✅ 成功标志**：
- 弹出「配置已保存，正在重启服务...」
- 如果服务正在运行，会自动重启
- 「服务控制」标签页状态更新

---

### 7. 验证 Dock 图标隐藏 ✅

**测试步骤**：
```bash
# 确保应用已关闭
killall CCE 2>/dev/null

# 使用 .app 包启动
open CCE.app
```

**✅ 成功标志**：
- macOS Dock 中**没有**出现 CCE 图标
- 只在顶部菜单栏看到 CCE 图标（小电脑图标）
- 可以通过菜单栏图标控制应用

**对比测试**（开发模式会显示 Dock 图标）：
```bash
# 开发模式（会显示 Dock 图标）
./build/cce-client
```

---

## 完整功能测试流程

### 准备工作
```bash
cd /Users/ethan/code/Claude-Code-Exchange

# 1. 确保代理服务配置正确
cat proxy/configs/config.yaml

# 2. 重新打包客户端
cd cce-client
make clean
make package

# 3. 启动应用
open CCE.app
```

### 测试场景 1: 首次使用

1. **启动应用**
   - 确认菜单栏图标出现
   - 确认 Dock 中无图标

2. **查看服务状态**
   - 点击菜单栏图标 → 显示主窗口
   - 「服务控制」标签显示「状态: 已停止」
   - 代理端口显示正确（`127.0.0.1:27015`）

3. **启动代理服务**
   - 点击「启动服务」按钮
   - 状态变为「状态: 运行中」
   - 「启动服务」按钮变灰
   - 「停止服务」和「重启服务」按钮可用

4. **验证代理功能**
   ```bash
   # 在另一个终端测试
   curl http://127.0.0.1:27015/status
   ```

### 测试场景 2: 配置管理

1. **查看现有配置**
   - 切换到「配置编辑」标签
   - 查看「服务管理」列表
   - 应显示 3-4 个服务（evaluator + executors）

2. **添加新的 executor**
   - 点击「添加服务」
   - 填写表单（使用真实或测试 API）
   - 保存并验证出现在列表中

3. **修改难度映射**
   - 切换到「难度映射」子标签
   - 修改难度级别 5 的映射
   - 验证下拉框更新

4. **修改功能开关**
   - 切换到「功能开关」子标签
   - 切换「Evaluator Fallback」开关
   - 验证复选框状态

5. **保存配置**
   - 点击「保存配置并重启服务」
   - 确认提示信息
   - 如果服务运行中，确认自动重启

### 测试场景 3: 日志监控

1. **查看实时日志**
   - 切换到「日志查看」标签
   - 确认显示今天的日志
   - 勾选「自动滚动」

2. **测试级别过滤**
   - 选择「debug」→ 验证只显示 debug 日志
   - 选择「info」→ 验证只显示 info 日志
   - 选择「全部」→ 验证显示所有日志

3. **测试手动刷新**
   - 在另一个终端发送几个请求
   - 点击「刷新」按钮
   - 确认新日志出现

4. **测试清空显示**
   - 点击「清空显示」
   - 确认日志内容被清空

### 测试场景 4: 性能监控（基础）

1. **查看监控面板**
   - 切换到「性能监控」标签
   - 确认显示服务状态
   - 确认显示「功能开发中」提示

2. **手动刷新**
   - 点击「立即刷新」
   - 确认服务状态更新

---

## 错误场景测试

### 1. 服务添加验证
- **测试空字段**：留空必填字段，应提示「所有字段都必须填写」
- **测试重复 ID**：添加已存在的服务 ID，应提示「服务ID已存在」

### 2. 端口占用
```bash
# 手动占用端口
nc -l 27015

# 尝试启动服务
# 应显示错误提示
```

### 3. 配置文件损坏
```bash
# 备份配置
cp ~/Library/Application\ Support/CCE/config.yaml ~/config.yaml.bak

# 破坏配置
echo "invalid yaml" > ~/Library/Application\ Support/CCE/config.yaml

# 启动应用
# 应显示错误或使用默认配置

# 恢复配置
mv ~/config.yaml.bak ~/Library/Application\ Support/CCE/config.yaml
```

---

## 性能测试

### 日志查看性能
```bash
# 生成大量日志
for i in {1..1000}; do
  curl http://127.0.0.1:27015/status > /dev/null 2>&1
done

# 在应用中查看日志
# 应能流畅显示最后 1000 行
```

### 自动刷新测试
```bash
# 保持应用在日志查看标签
# 观察 5 秒后自动刷新
# CPU 和内存使用应保持稳定
```

---

## 预期结果汇总

| 测试项 | 预期结果 | 优先级 |
|--------|---------|--------|
| 端口显示 | `127.0.0.1:27015` | 高 |
| Dock 图标 | 不显示 | 高 |
| 服务添加 | 成功添加并显示 | 高 |
| 服务编辑 | 成功修改（ID 不可改） | 高 |
| 服务删除 | 成功删除并提示 | 高 |
| 日志过滤 | 正确过滤各级别 | 中 |
| 配置保存 | 成功保存并重启 | 高 |
| 服务启动 | 成功启动并监听 27015 | 高 |
| 服务停止 | 成功停止并释放端口 | 高 |
| 自动刷新 | 日志和监控定期更新 | 中 |

---

## 常见问题排查

### 应用无法启动
```bash
# 检查日志
tail -f ~/Library/Logs/CCE/cce-client.log

# 检查配置
cat ~/Library/Application\ Support/CCE/config.yaml

# 重置配置
rm ~/Library/Application\ Support/CCE/config.yaml
```

### 服务启动失败
```bash
# 检查端口占用
lsof -i :27015

# 检查代理服务二进制
ls -la CCE.app/Contents/Resources/claude-proxy

# 检查执行权限
chmod +x CCE.app/Contents/Resources/claude-proxy
```

### Dock 图标仍然显示
```bash
# 确认使用 .app 启动
killall CCE
open CCE.app  # 正确

# 不要直接运行二进制
./build/cce-client  # 错误，会显示 Dock 图标
```

### 日志不显示
```bash
# 检查日志文件路径
ls -la ~/Library/Application\ Support/CCE/logs/

# 确认代理服务运行
ps aux | grep claude-proxy

# 手动触发请求
curl http://127.0.0.1:27015/health
```

---

## 测试清单

- [ ] 端口显示正确（无乱码）
- [ ] Dock 图标隐藏
- [ ] 服务添加功能
- [ ] 服务编辑功能
- [ ] 服务删除功能
- [ ] 日志级别过滤
- [ ] 配置保存和重启
- [ ] 服务启动成功
- [ ] 服务停止成功
- [ ] 自动刷新工作正常
- [ ] 错误提示清晰
- [ ] 确认对话框工作
- [ ] 表单验证有效

**测试通过后，可以开始正常使用！**
