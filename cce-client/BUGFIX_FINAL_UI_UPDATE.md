# æœ€ç»ˆä¿®å¤ï¼šUI ä¸æ›´æ–°é—®é¢˜

## ğŸ¯ é—®é¢˜å®šä½æˆåŠŸï¼

### æ ¹æœ¬åŸå› 

**çŠ¶æ€å›è°ƒè¢«è¦†ç›–**ï¼šManager åªæ”¯æŒå•ä¸ªå›è°ƒï¼Œåæ³¨å†Œçš„è¦†ç›–å‰é¢çš„ã€‚

### ä»£ç æ‰§è¡Œé¡ºåºï¼ˆmain.goï¼‰

```go
// 1. åˆ›å»º MainWindowï¼ˆåŒ…å« ControlViewï¼‰
mainWindow := ui.NewMainWindow(a, serviceManager, configManager)
// â†“ ControlView æ³¨å†Œå›è°ƒï¼šserviceManager.SetStatusCallback(...)

// 2. åˆ›å»º SystemTray
systray := ui.NewSystemTray(a, mainWindow, serviceManager)
// â†“ SystemTray æ³¨å†Œå›è°ƒï¼šserviceManager.SetStatusCallback(...)
// âŒ è¦†ç›–äº† ControlView çš„å›è°ƒï¼
```

### ç»“æœ

- âœ… æ‰˜ç›˜å›¾æ ‡æ›´æ–°ï¼ˆSystemTray å›è°ƒï¼‰
- âŒ ä¸»çª—å£UIä¸æ›´æ–°ï¼ˆControlView å›è°ƒè¢«è¦†ç›–ï¼‰

---

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### æ”¹ä¸ºå¤šç›‘å¬å™¨æ¨¡å¼

æ”¯æŒæ³¨å†Œå¤šä¸ªçŠ¶æ€ç›‘å¬å™¨ï¼Œæ‰€æœ‰ç›‘å¬å™¨éƒ½ä¼šè¢«é€šçŸ¥ã€‚

### ä¿®æ”¹å†…å®¹

#### 1. Manager ç»“æ„ï¼ˆservice/manager.goï¼‰

```go
// ä¿®æ”¹å‰
type Manager struct {
    // ...
    statusCallback func(Status) // å•ä¸ªå›è°ƒ
}

// ä¿®æ”¹å
type Manager struct {
    // ...
    statusListeners   []func(Status) // ç›‘å¬å™¨åˆ—è¡¨ âœ…
    statusListenersMu sync.RWMutex   // çº¿ç¨‹å®‰å…¨
}
```

#### 2. æ·»åŠ ç›‘å¬å™¨æ–¹æ³•

```go
// æ–°æ–¹æ³•ï¼šæ·»åŠ ç›‘å¬å™¨
func (m *Manager) AddStatusListener(listener func(Status)) {
    m.statusListenersMu.Lock()
    defer m.statusListenersMu.Unlock()
    m.statusListeners = append(m.statusListeners, listener)
    log.Printf("[ç›‘å¬å™¨] å·²æ·»åŠ çŠ¶æ€ç›‘å¬å™¨ï¼Œå½“å‰å…± %d ä¸ª", len(m.statusListeners))
}

// ä¿ç•™æ—§æ–¹æ³•å‘åå…¼å®¹
func (m *Manager) SetStatusCallback(callback func(Status)) {
    m.AddStatusListener(callback)
}
```

#### 3. é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨

```go
func (m *Manager) setStatus(status Status) {
    m.status = status
    log.Printf("[çŠ¶æ€å˜æ›´] %s", status)

    // è·å–æ‰€æœ‰ç›‘å¬å™¨
    m.statusListenersMu.RLock()
    listenerCount := len(m.statusListeners)
    listeners := make([]func(Status), listenerCount)
    copy(listeners, m.statusListeners)
    m.statusListenersMu.RUnlock()

    // é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨
    log.Printf("[çŠ¶æ€å˜æ›´] é€šçŸ¥ %d ä¸ªç›‘å¬å™¨...", listenerCount)
    for i, listener := range listeners {
        log.Printf("[çŠ¶æ€å˜æ›´] è§¦å‘ç›‘å¬å™¨ %d/%d", i+1, listenerCount)
        listener(status)
    }
    log.Printf("[çŠ¶æ€å˜æ›´] æ‰€æœ‰ç›‘å¬å™¨å·²é€šçŸ¥")
}
```

---

## ğŸ§ª æµ‹è¯•æ–°ç‰ˆæœ¬

### ç¬¬ 1 æ­¥ï¼šå®Œå…¨æ¸…ç†

```bash
killall CCE
pkill -9 claude-proxy
lsof -i :27015  # åº”è¯¥æ— è¾“å‡º
```

### ç¬¬ 2 æ­¥ï¼šä»ç»ˆç«¯å¯åŠ¨ï¼ˆçœ‹æ—¥å¿—ï¼‰

```bash
cd /Users/ethan/code/Claude-Code-Exchange/cce-client
./CCE.app/Contents/MacOS/CCE
```

### ç¬¬ 3 æ­¥ï¼šè§‚å¯Ÿå¯åŠ¨æ—¥å¿—

åº”è¯¥çœ‹åˆ°ï¼š
```
[ç›‘å¬å™¨] å·²æ·»åŠ çŠ¶æ€ç›‘å¬å™¨ï¼Œå½“å‰å…± 1 ä¸ª  # â† ControlView
[ç›‘å¬å™¨] å·²æ·»åŠ çŠ¶æ€ç›‘å¬å™¨ï¼Œå½“å‰å…± 2 ä¸ª  # â† SystemTray
[æŒ‰é’®çŠ¶æ€] isRunning=false
[æŒ‰é’®çŠ¶æ€] è®¾ç½®ä¸ºåœæ­¢çŠ¶æ€ï¼ˆå¯åŠ¨æŒ‰é’®å¯ç”¨ï¼‰
```

### ç¬¬ 4 æ­¥ï¼šç‚¹å‡»ã€Œå¯åŠ¨æœåŠ¡ã€

**é¢„æœŸæ—¥å¿—**ï¼š

```
[æŒ‰é’®ç‚¹å‡»] ç”¨æˆ·ç‚¹å‡»å¯åŠ¨æœåŠ¡
å‡†å¤‡å¯åŠ¨ä»£ç†æœåŠ¡...
[çŠ¶æ€å˜æ›´] å¯åŠ¨ä¸­
[çŠ¶æ€å˜æ›´] é€šçŸ¥ 2 ä¸ªç›‘å¬å™¨...              # â† å…³é”®ï¼
[çŠ¶æ€å˜æ›´] è§¦å‘ç›‘å¬å™¨ 1/2
[UIæ›´æ–°] æ”¶åˆ°çŠ¶æ€å˜æ›´: å¯åŠ¨ä¸­               # â† ControlView æ”¶åˆ°ï¼
[æŒ‰é’®çŠ¶æ€] isRunning=false
[æŒ‰é’®çŠ¶æ€] è®¾ç½®ä¸ºåœæ­¢çŠ¶æ€ï¼ˆå¯åŠ¨æŒ‰é’®å¯ç”¨ï¼‰
[UIæ›´æ–°] æŒ‰é’®çŠ¶æ€å·²æ›´æ–°
[çŠ¶æ€å˜æ›´] è§¦å‘ç›‘å¬å™¨ 2/2
å›¾æ ‡çŠ¶æ€æ›´æ–°: å¯åŠ¨ä¸­                       # â† SystemTray æ”¶åˆ°ï¼
[çŠ¶æ€å˜æ›´] æ‰€æœ‰ç›‘å¬å™¨å·²é€šçŸ¥
[æŒ‰é’®ç‚¹å‡»] Start()æ–¹æ³•è¿”å›æˆåŠŸ
[ç­‰å¾…å°±ç»ª] å¼€å§‹ç­‰å¾…æœåŠ¡å°±ç»ª...
...
[å¥åº·æ£€æŸ¥] çŠ¶æ€ç : 200, ç»“æœ: true
[çŠ¶æ€å˜æ›´] è¿è¡Œä¸­
[çŠ¶æ€å˜æ›´] é€šçŸ¥ 2 ä¸ªç›‘å¬å™¨...
[çŠ¶æ€å˜æ›´] è§¦å‘ç›‘å¬å™¨ 1/2
[UIæ›´æ–°] æ”¶åˆ°çŠ¶æ€å˜æ›´: è¿è¡Œä¸­               # â† ControlView æ”¶åˆ°ï¼
[æŒ‰é’®çŠ¶æ€] isRunning=true
[æŒ‰é’®çŠ¶æ€] è®¾ç½®ä¸ºè¿è¡ŒçŠ¶æ€ï¼ˆå¯åŠ¨æŒ‰é’®ç¦ç”¨ï¼‰ # â† æŒ‰é’®åº”è¯¥å˜ç°ï¼
[æŒ‰é’®çŠ¶æ€] æ‰€æœ‰æŒ‰é’®å·²åˆ·æ–°
[UIæ›´æ–°] æŒ‰é’®çŠ¶æ€å·²æ›´æ–°
[çŠ¶æ€å˜æ›´] è§¦å‘ç›‘å¬å™¨ 2/2
å›¾æ ‡çŠ¶æ€æ›´æ–°: è¿è¡Œä¸­                       # â† SystemTray æ”¶åˆ°ï¼
[çŠ¶æ€å˜æ›´] æ‰€æœ‰ç›‘å¬å™¨å·²é€šçŸ¥
```

### ç¬¬ 5 æ­¥ï¼šéªŒè¯ UI å˜åŒ–

**ç•Œé¢åº”è¯¥ç«‹å³æ›´æ–°**ï¼š

- âœ… çŠ¶æ€æ˜¾ç¤ºï¼šå¯åŠ¨ä¸­ â†’ è¿è¡Œä¸­
- âœ… ã€Œå¯åŠ¨æœåŠ¡ã€æŒ‰é’®ï¼šå˜ç°ï¼ˆç¦ç”¨ï¼‰
- âœ… ã€Œåœæ­¢æœåŠ¡ã€æŒ‰é’®ï¼šå¯ç”¨ï¼ˆç»¿è‰²ï¼‰
- âœ… ã€Œé‡å¯æœåŠ¡ã€æŒ‰é’®ï¼šå¯ç”¨ï¼ˆç»¿è‰²ï¼‰

---

## ğŸ“Š ä¿®å¤å¯¹æ¯”

### ä¿®å¤å‰

| ç»„ä»¶ | æ³¨å†Œå›è°ƒ | æ”¶åˆ°é€šçŸ¥ | ç»“æœ |
|------|---------|---------|------|
| ControlView | âœ“ | âœ— | UI ä¸æ›´æ–° |
| SystemTray | âœ“ (è¦†ç›–) | âœ“ | å›¾æ ‡æ›´æ–° |

**é—®é¢˜**ï¼šåªæœ‰æœ€åæ³¨å†Œçš„ç›‘å¬å™¨ç”Ÿæ•ˆ

### ä¿®å¤å

| ç»„ä»¶ | æ³¨å†Œå›è°ƒ | æ”¶åˆ°é€šçŸ¥ | ç»“æœ |
|------|---------|---------|------|
| ControlView | âœ“ (ç›‘å¬å™¨1) | âœ“ | UI æ›´æ–° âœ… |
| SystemTray | âœ“ (ç›‘å¬å™¨2) | âœ“ | å›¾æ ‡æ›´æ–° âœ… |

**æ•ˆæœ**ï¼šæ‰€æœ‰ç›‘å¬å™¨éƒ½ç”Ÿæ•ˆ

---

## ğŸ‰ é¢„æœŸæ•ˆæœ

å¯åŠ¨æœåŠ¡åï¼š
1. **æ‰˜ç›˜å›¾æ ‡** ä»ç°è‰²å˜ä¸ºç»¿è‰²
2. **ä¸»çª—å£çŠ¶æ€** æ˜¾ç¤ºã€Œè¿è¡Œä¸­ã€
3. **å¯åŠ¨æŒ‰é’®** å˜ç°ä¸å¯ç‚¹å‡»
4. **åœæ­¢/é‡å¯æŒ‰é’®** å˜ä¸ºå¯ç”¨

---

## ğŸ” å¦‚æœè¿˜æœ‰é—®é¢˜

### æ£€æŸ¥ç‚¹ 1ï¼šç›‘å¬å™¨æ•°é‡

æ—¥å¿—ä¸­åº”è¯¥çœ‹åˆ°ï¼š
```
[ç›‘å¬å™¨] å·²æ·»åŠ çŠ¶æ€ç›‘å¬å™¨ï¼Œå½“å‰å…± 2 ä¸ª
```

å¦‚æœåªæœ‰ 1 ä¸ªï¼Œè¯´æ˜å…¶ä¸­ä¸€ä¸ªç»„ä»¶æ²¡æœ‰æ³¨å†Œã€‚

### æ£€æŸ¥ç‚¹ 2ï¼šé€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨

çŠ¶æ€å˜æ›´æ—¶åº”è¯¥çœ‹åˆ°ï¼š
```
[çŠ¶æ€å˜æ›´] é€šçŸ¥ 2 ä¸ªç›‘å¬å™¨...
[çŠ¶æ€å˜æ›´] è§¦å‘ç›‘å¬å™¨ 1/2
[çŠ¶æ€å˜æ›´] è§¦å‘ç›‘å¬å™¨ 2/2
```

### æ£€æŸ¥ç‚¹ 3ï¼šControlView æ”¶åˆ°é€šçŸ¥

åº”è¯¥çœ‹åˆ°ï¼š
```
[UIæ›´æ–°] æ”¶åˆ°çŠ¶æ€å˜æ›´: è¿è¡Œä¸­
[æŒ‰é’®çŠ¶æ€] isRunning=true
[æŒ‰é’®çŠ¶æ€] è®¾ç½®ä¸ºè¿è¡ŒçŠ¶æ€ï¼ˆå¯åŠ¨æŒ‰é’®ç¦ç”¨ï¼‰
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `internal/service/manager.go` | æ”¹ä¸ºå¤šç›‘å¬å™¨æ¨¡å¼ |
| `internal/service/manager.go` | æ·»åŠ  `AddStatusListener()` |
| `internal/service/manager.go` | ä¿®æ”¹ `setStatus()` é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨ |
| `internal/service/manager.go` | ä¿ç•™ `SetStatusCallback()` å‘åå…¼å®¹ |

---

## âœ… éªŒè¯æ¸…å•

æµ‹è¯•åè¯·ç¡®è®¤ï¼š

- [ ] ç»ˆç«¯æ˜¾ç¤ºã€Œå·²æ·»åŠ çŠ¶æ€ç›‘å¬å™¨ï¼Œå½“å‰å…± 2 ä¸ªã€
- [ ] ç‚¹å‡»å¯åŠ¨åçœ‹åˆ°ã€Œé€šçŸ¥ 2 ä¸ªç›‘å¬å™¨ã€
- [ ] çœ‹åˆ°ã€Œ[UIæ›´æ–°] æ”¶åˆ°çŠ¶æ€å˜æ›´: å¯åŠ¨ä¸­ã€
- [ ] çœ‹åˆ°ã€Œ[UIæ›´æ–°] æ”¶åˆ°çŠ¶æ€å˜æ›´: è¿è¡Œä¸­ã€
- [ ] çœ‹åˆ°ã€Œ[æŒ‰é’®çŠ¶æ€] isRunning=trueã€
- [ ] çœ‹åˆ°ã€Œè®¾ç½®ä¸ºè¿è¡ŒçŠ¶æ€ï¼ˆå¯åŠ¨æŒ‰é’®ç¦ç”¨ï¼‰ã€
- [ ] **ç•Œé¢çŠ¶æ€å˜ä¸ºã€Œè¿è¡Œä¸­ã€**
- [ ] **å¯åŠ¨æŒ‰é’®å˜ç°ä¸å¯ç‚¹å‡»**
- [ ] **åœæ­¢/é‡å¯æŒ‰é’®å¯ç”¨**

---

**ç°åœ¨å¼€å§‹æµ‹è¯•å§ï¼** ğŸš€

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ ä¼šçœ‹åˆ° UI ç»ˆäºæ›´æ–°äº†ï¼
