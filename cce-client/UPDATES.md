# CCE 客户端更新记录

## 2025-11-14 - 修复与功能增强

### 🐛 Bug 修复

#### 1. **端口显示乱码问题** ✅
- **问题**：主界面显示代理端口为 `127.0.0.1:槢` （乱码字符）
- **原因**：错误地使用 `string(rune(port))` 将端口号 27015 当作 Unicode 码点转换
- **修复**：改用 `fmt.Sprintf("127.0.0.1:%d", port)` 正确格式化端口号
- **位置**：`internal/ui/main_window.go:126`

#### 2. **日志级别过滤功能** ✅
- **问题**：日志级别过滤函数 `containsLevel()` 没有正确实现，永远返回 true
- **修复**：实现了正确的日志级别匹配逻辑
- **支持格式**：
  - JSON 格式：`"level":"info"` 或 `"level": "info"`
  - 文本格式：`[INFO]` 或 `INFO:`
- **位置**：`internal/ui/logs_view.go:184-208`

#### 3. **错误对话框显示问题** ✅
- **问题**：`showError()` 函数调用参数错误
- **修复**：使用 `fmt.Errorf()` 创建正确的 error 类型
- **位置**：`internal/ui/utils.go:12-14`

### ✨ 新功能

#### 1. **服务管理对话框** ✅
- **添加服务**：完整的表单对话框，支持添加新的 evaluator/executor 服务
- **编辑服务**：可以编辑现有服务的所有配置（ID 除外）
- **删除服务**：带确认对话框的删除功能
- **输入验证**：
  - 所有字段必填验证
  - 服务 ID 重复检查
  - 编辑时禁止修改 ID
- **位置**：`internal/ui/config_view.go:227-367`

#### 2. **服务配置字段**
支持配置的字段：
- 服务 ID（唯一标识符）
- 服务名称（显示名称）
- API URL（服务地址）
- API Key（密码输入框）
- 角色（evaluator/executor 下拉选择）
- 支持 Thinking（复选框，用于第三方 API 兼容性）

### 📦 打包改进

#### macOS 应用打包
- **隐藏 Dock 图标**：通过 `LSUIElement: true` 配置实现
- **手动打包流程**：避免 fyne package 工具兼容性问题
- **Makefile 集成**：一键打包命令 `make package`

### 🎯 功能状态

| 功能模块 | 状态 | 说明 |
|---------|------|------|
| 服务控制 | ✅ 可用 | 启动/停止/重启代理服务 |
| 配置编辑 - 服务管理 | ✅ 完整 | 添加/编辑/删除服务 |
| 配置编辑 - 难度映射 | ✅ 可用 | 1-5 级难度映射配置 |
| 配置编辑 - 功能开关 | ✅ 可用 | 三项功能开关配置 |
| 配置编辑 - 高级设置 | ⚠️ 基础 | 端口和日志级别（需要完善） |
| 日志查看 | ✅ 可用 | 级别过滤、自动刷新 |
| 性能监控 | 🚧 占位 | 基础框架，需要实现统计 |

### 🔜 待实现功能

#### 高优先级
1. **配置编辑 - 高级设置**
   - 完善端口号验证和更新逻辑
   - 添加超时配置（read/write/request timeout）
   - Evaluator 配置（model, max_tokens, prompt_template）

2. **性能监控**
   - 日志解析和请求统计
   - 难度分布可视化
   - 平均响应时间统计
   - 实时请求监控

#### 中优先级
3. **实时状态更新**
   - 服务状态实时监控
   - 端口占用检测
   - 进程存活检查

4. **配置验证增强**
   - 保存前完整性检查
   - URL 格式验证
   - API Key 有效性提示

5. **用户体验优化**
   - 配置导入/导出功能
   - 配置预设模板
   - 一键重置为默认配置

#### 低优先级
6. **高级功能**
   - 日志实时尾随（tail -f）
   - 请求日志查看器
   - 服务健康检查
   - API 连接测试

### 📝 使用说明

#### 启动应用（隐藏 Dock 图标）
```bash
cd /Users/ethan/code/Claude-Code-Exchange/cce-client
make package  # 打包
open CCE.app  # 启动（只显示菜单栏图标）
```

#### 开发模式（显示 Dock 图标）
```bash
make run  # 直接运行二进制
```

#### 添加新服务
1. 打开应用，切换到「配置编辑」标签
2. 切换到「服务管理」子标签
3. 点击「添加服务」按钮
4. 填写表单：
   - 服务 ID：唯一标识符（如 `my-api`）
   - 服务名称：显示名称（如 `我的 API`）
   - API URL：完整的 API 地址
   - API Key：你的 API 密钥
   - 角色：选择 `evaluator` 或 `executor`
   - 支持 Thinking：勾选（官方 API）或不勾选（第三方 API）
5. 点击「保存」
6. 点击底部「保存配置并重启服务」按钮

#### 编辑现有服务
1. 在服务列表中点击选中要编辑的服务
2. 点击「编辑服务」按钮
3. 修改配置（服务 ID 不可修改）
4. 点击「保存」
5. 点击底部「保存配置并重启服务」按钮

#### 删除服务
1. 在服务列表中点击选中要删除的服务
2. 点击「删除服务」按钮
3. 确认删除
4. 点击底部「保存配置并重启服务」按钮
5. **注意**：删除后需要手动调整难度映射配置

### 🔧 技术细节

#### 修改的文件
```
internal/ui/main_window.go   - 修复端口显示
internal/ui/config_view.go   - 添加服务编辑对话框
internal/ui/logs_view.go     - 修复日志过滤
internal/ui/utils.go         - 修复错误对话框
Makefile                     - 改进打包流程
```

#### 依赖版本
- Go: 1.21+
- Fyne: v2.5.4
- macOS: 10.14+

### 🎉 测试建议

1. **端口显示**：检查主界面「服务控制」标签，确认显示为 `127.0.0.1:27015`
2. **服务添加**：尝试添加一个新服务，验证表单验证和保存逻辑
3. **服务编辑**：选中现有服务并编辑，确认修改生效
4. **服务删除**：删除测试服务，确认列表更新
5. **日志过滤**：切换日志级别，验证过滤效果
6. **配置保存**：修改配置后保存并重启服务，确认生效
7. **Dock 隐藏**：关闭应用，使用 `open CCE.app` 启动，确认不显示 Dock 图标

### ⚠️ 注意事项

1. **配置文件路径**：`~/Library/Application Support/CCE/config.yaml`
2. **代理服务配置**：应用使用的是代理服务的配置 `proxy/configs/config.yaml`
3. **二进制依赖**：确保 `resources/claude-proxy` 存在且可执行
4. **权限问题**：首次运行可能需要允许系统权限

### 📊 性能优化

- 日志自动刷新间隔：5 秒
- 监控自动刷新间隔：10 秒
- 日志显示最大行数：1000 行

---

**下一步计划**：实现性能监控功能的日志解析和统计功能
