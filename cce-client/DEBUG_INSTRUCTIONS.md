# 调试 UI 不更新问题 - 测试步骤

## 📋 测试前准备

### 第 1 步：完全清理旧环境

```bash
# 1. 关闭所有 CCE 应用
killall CCE

# 2. 清理所有 claude-proxy 进程
pkill -9 claude-proxy

# 3. 确认端口已释放
lsof -i :27015
# 应该无输出

# 4. 等待 2 秒
sleep 2
```

### 第 2 步：启动新版本（调试版）

```bash
# 从终端启动，这样可以看到所有调试输出
cd /Users/ethan/code/Claude-Code-Exchange/cce-client
open CCE.app

# 或者直接运行二进制（推荐，输出更清晰）
./CCE.app/Contents/MacOS/CCE
```

**重要**：必须从终端启动，才能看到调试日志！

---

## 🔍 测试步骤

### 步骤 1：观察初始状态

应用启动后，终端应该显示：
```
[初始化相关日志]
```

在应用界面，应该看到：
- 状态：已停止
- 「启动服务」按钮可用（绿色）
- 其他按钮灰色

### 步骤 2：点击「启动服务」

**预期终端输出**（按顺序）：

```
[按钮点击] 用户点击启动服务
[准备启动] 检查端口...
[准备启动] 端口空闲
准备启动代理服务...
二进制路径: /path/to/claude-proxy
配置文件路径: /path/to/proxy-config.yaml
代理服务已启动，PID: xxxxx
[状态变更] 启动中
[状态变更] 触发UI回调...
[UI更新] 收到状态变更: 启动中
[UI更新] 标签已刷新
[按钮状态] isRunning=false
[按钮状态] 设置为停止状态（启动按钮启用）
[按钮状态] 所有按钮已刷新
[UI更新] 按钮状态已更新
[状态变更] UI回调已执行
[按钮点击] Start()方法返回成功
[等待就绪] 开始等待服务就绪...
[等待就绪] 第 1/60 次检查
[健康检查] 检查 http://127.0.0.1:27015/health
[健康检查] 失败: Get "http://127.0.0.1:27015/health": dial tcp 127.0.0.1:27015: connect: connection refused
[等待就绪] 第 2/60 次检查
[健康检查] 检查 http://127.0.0.1:27015/health
[健康检查] 状态码: 200, 结果: true
[等待就绪] 健康检查通过，设置状态为运行中
[状态变更] 运行中
[状态变更] 触发UI回调...
[UI更新] 收到状态变更: 运行中
[UI更新] 标签已刷新
[按钮状态] isRunning=true
[按钮状态] 设置为运行状态（启动按钮禁用）
[按钮状态] 所有按钮已刷新
[UI更新] 按钮状态已更新
[状态变更] UI回调已执行
代理服务已就绪
```

### 步骤 3：观察UI变化

**预期界面变化**：

启动过程中（1-2秒）：
- 状态：启动中 ✅
- 按钮：可能还未更新

启动完成后：
- 状态：运行中 ✅
- 「启动服务」按钮：灰色（禁用）✅
- 「停止服务」按钮：绿色（可用）✅
- 「重启服务」按钮：绿色（可用）✅

---

## 🐛 诊断问题

### 情况 A：完全没有日志输出

**可能原因**：
- 应用是从 Finder 启动的（看不到终端输出）
- 运行的是旧版本

**解决方法**：
```bash
# 从终端重新启动
killall CCE
./CCE.app/Contents/MacOS/CCE
```

### 情况 B：看到日志，但没有 [UI更新] 日志

**说明**：状态回调没有被调用

**检查点**：
1. 是否看到 `[状态变更] 警告: 状态回调未设置!`
2. 如果是，说明回调注册失败

### 情况 C：看到 [UI更新] 日志，但界面没变化

**说明**：UI 更新被调用了，但没有生效

**可能原因**：
1. Fyne 框架的 Refresh() 不工作
2. 组件引用错误
3. UI 线程问题

### 情况 D：看到 [健康检查] 一直失败

**说明**：代理服务启动了，但端口没有监听

**检查**：
```bash
# 手动检查端口
lsof -i :27015

# 手动测试健康检查
curl http://127.0.0.1:27015/health
```

---

## 📝 记录问题

请记录以下信息：

### 1. 完整的终端输出

```bash
# 复制从启动到点击按钮后30秒内的所有输出
```

### 2. 哪些日志出现了？

- [ ] `[按钮点击] 用户点击启动服务`
- [ ] `[状态变更] 启动中`
- [ ] `[状态变更] 触发UI回调...`
- [ ] `[UI更新] 收到状态变更: 启动中`
- [ ] `[按钮状态] isRunning=false`
- [ ] `[等待就绪] 开始等待服务就绪...`
- [ ] `[健康检查] 状态码: 200, 结果: true`
- [ ] `[状态变更] 运行中`
- [ ] `[UI更新] 收到状态变更: 运行中`
- [ ] `[按钮状态] isRunning=true`

### 3. UI 实际状态

启动前：
- 状态显示：__________
- 启动按钮：__________

点击后立即：
- 状态显示：__________
- 启动按钮：__________

30秒后：
- 状态显示：__________
- 启动按钮：__________

### 4. 服务实际状态

```bash
# 进程
ps aux | grep claude-proxy

# 端口
lsof -i :27015

# 健康检查
curl http://127.0.0.1:27015/health
```

---

## 🎯 预期结果 vs 实际结果

| 项目 | 预期 | 实际 | 结果 |
|------|------|------|------|
| 终端有调试输出 | ✓ | ? | ? |
| 看到 [按钮点击] | ✓ | ? | ? |
| 看到 [状态变更] 启动中 | ✓ | ? | ? |
| 看到 [UI更新] 启动中 | ✓ | ? | ? |
| UI 显示「启动中」 | ✓ | ? | ? |
| 看到健康检查成功 | ✓ | ? | ? |
| 看到 [状态变更] 运行中 | ✓ | ? | ? |
| 看到 [UI更新] 运行中 | ✓ | ? | ? |
| UI 显示「运行中」 | ✓ | ? | ? |
| 启动按钮变灰 | ✓ | ? | ? |
| 停止按钮可用 | ✓ | ? | ? |

---

## 💡 快速测试命令

在一个终端运行应用：
```bash
cd /Users/ethan/code/Claude-Code-Exchange/cce-client
./CCE.app/Contents/MacOS/CCE 2>&1 | tee debug.log
```

在另一个终端监控：
```bash
# 监控进程
watch -n 1 'ps aux | grep -E "CCE|claude-proxy" | grep -v grep'

# 监控端口
watch -n 1 'lsof -i :27015'
```

完成测试后，请把 `debug.log` 文件或终端输出发给我！

---

**准备好了吗？开始测试吧！** 🚀
